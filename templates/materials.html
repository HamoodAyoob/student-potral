{% extends 'base.html' %}

{% block title %}Notes - Yenepoya Portal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-book"></i> Study Materials</h2>
                {% if not is_student %}
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadNoteModal">
                    <i class="fas fa-upload"></i> Upload Material
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    {% if is_student %}
    <!-- Student View -->
    <div class="row">
        <div class="col-lg-9">
            <!-- Notes Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-sticky-note"></i> Study Notes</h5>
                </div>
                <div class="card-body">
                    {% if notes %}
                    <div class="materials-list">
                        {% for note in notes %}
                        <div class="material-item">
                            <div class="material-icon">
                                <i class="fas fa-file-pdf text-danger"></i>
                            </div>
                            <div class="material-content">
                                <h6 class="material-title">{{ note.title }}</h6>
                                <p class="material-subject">{{ note.subject.name }}</p>
                                <p class="material-teacher">By {{ note.teacher.user.get_full_name }}</p>
                                <small class="material-date">{{ note.uploaded_at|date:"M d, Y" }}</small>
                            </div>
                            <div class="material-actions">
                                <a href="{{ note.file.url }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a href="{{ note.file.url }}" class="btn btn-primary btn-sm" download>
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-sticky-note fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No study notes available yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Question Banks Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-question-circle"></i> Question Banks</h5>
                </div>
                <div class="card-body">
                    {% if question_banks %}
                    <div class="materials-list">
                        {% for qb in question_banks %}
                        <div class="material-item question-bank-item">
                            <div class="material-icon">
                                <i class="fas fa-question-circle text-warning"></i>
                            </div>
                            <div class="material-content">
                                <h6 class="material-title">{{ qb.title }}</h6>
                                <p class="material-subject">{{ qb.subject.name }}</p>
                                <p class="material-teacher">By {{ qb.teacher.user.get_full_name }}</p>
                                <small class="material-date">{{ qb.uploaded_at|date:"M d, Y" }}</small>
                            </div>
                            <div class="material-actions">
                                <a href="{{ qb.file.url }}" class="btn btn-outline-warning btn-sm" target="_blank">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a href="{{ qb.file.url }}" class="btn btn-warning btn-sm" download>
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard-question fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No question banks available yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- References Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-bookmark"></i> Reference Materials</h5>
                </div>
                <div class="card-body">
                    {% if references %}
                    <div class="materials-list">
                        {% for ref in references %}
                        <div class="material-item reference-item">
                            <div class="material-icon">
                                <i class="fas fa-bookmark text-info"></i>
                            </div>
                            <div class="material-content">
                                <h6 class="material-title">{{ ref.title }}</h6>
                                <p class="material-subject">{{ ref.subject.name }}</p>
                                <p class="material-teacher">By {{ ref.teacher.user.get_full_name }}</p>
                                <small class="material-date">{{ ref.uploaded_at|date:"M d, Y" }}</small>
                            </div>
                            <div class="material-actions">
                                <a href="{{ ref.file.url }}" class="btn btn-outline-info btn-sm" target="_blank">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a href="{{ ref.file.url }}" class="btn btn-info btn-sm" download>
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No reference materials available yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Slides Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-presentation-screen"></i> Presentation Slides</h5>
                </div>
                <div class="card-body">
                    {% if slides %}
                    <div class="materials-list">
                        {% for slide in slides %}
                        <div class="material-item slides-item">
                            <div class="material-icon">
                                <i class="fas fa-file-powerpoint text-success"></i>
                            </div>
                            <div class="material-content">
                                <h6 class="material-title">{{ slide.title }}</h6>
                                <p class="material-subject">{{ slide.subject.name }}</p>
                                <p class="material-teacher">By {{ slide.teacher.user.get_full_name }}</p>
                                <small class="material-date">{{ slide.uploaded_at|date:"M d, Y" }}</small>
                            </div>
                            <div class="material-actions">
                                <a href="{{ slide.file.url }}" class="btn btn-outline-success btn-sm" target="_blank">
                                    <i class="fas fa-eye"></i> View
                                </a>
                                <a href="{{ slide.file.url }}" class="btn btn-success btn-sm" download>
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-presentation-screen fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No presentation slides available yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-3">
            <!-- Search and Filter -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-search"></i> Search & Filter</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="searchNotes" placeholder="Search materials...">
                    </div>
                    <div class="mb-3">
                        <select class="form-select" id="filterSubject">
                            <option value="">All Subjects</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Progressive Web Apps">Progressive Web Apps</option>
                            <option value="Deep Learning">Deep Learning</option>
                            <option value="NLP">NLP</option>
                            <option value="Principles of Virtualization">Principles of Virtualization</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <select class="form-select" id="filterType">
                            <option value="">All Types</option>
                            <option value="notes">Study Notes</option>
                            <option value="questionbank">Question Banks</option>
                            <option value="reference">References</option>
                            <option value="slides">Slides</option>
                        </select>
                    </div>
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearFilters()">
                        <i class="fas fa-times"></i> Clear Filters
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- Teacher View -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Your Uploads</h5>
                </div>
                <div class="card-body">
                    {% if notes %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Subject</th>
                                    <th>Type</th>
                                    <th>Upload Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for note in notes %}
                                <tr>
                                    <td>
                                        <strong>{{ note.title }}</strong>
                                        <br><small class="text-muted">{{ note.description|truncatewords:8 }}</small>
                                    </td>
                                    <td>{{ note.subject.name }}</td>
                                    <td>
                                        {% if note.material_type == 'question_bank' %}
                                            <span class="badge bg-warning">Question Bank</span>
                                        {% elif note.material_type == 'reference' %}
                                            <span class="badge bg-info">Reference</span>
                                        {% elif note.material_type == 'slides' %}
                                            <span class="badge bg-success">Slides</span>
                                        {% else %}
                                            <span class="badge bg-primary">Study Note</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ note.uploaded_at|date:"M d, Y" }}</td>
                                    <td>
                                        <a href="{{ note.file.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteNote({{ note.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-upload fa-3x text-muted mb-3"></i>
                        <p class="text-muted">You haven't uploaded any materials yet.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Material Modal -->
    <div class="modal fade" id="uploadNoteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Upload Study Material</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        {% if form %}
                            {{ form.as_p }}
                        {% endif %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Supported formats:</strong> PDF, DOC, DOCX, PPT, PPTX (Max: 50MB)
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Upload Material
                        </button>
                    </div>
                    </form>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<style>
/* Horizontal Material List Layout */
.materials-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.material-item {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border-left: 4px solid #007bff;
}

.material-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(0,0,0,0.12);
}

.question-bank-item {
    border-left-color: #ffc107;
}

.reference-item {
    border-left-color: #17a2b8;
}

.slides-item {
    border-left-color: #28a745;
}

.material-icon {
    flex-shrink: 0;
    width: 60px;
    text-align: center;
    margin-right: 20px;
}

.material-icon i {
    font-size: 2.5rem;
}

.material-content {
    flex-grow: 1;
    min-width: 0;
}

.material-title {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
    font-size: 1.1rem;
}

.material-subject {
    color: #007bff;
    font-weight: 500;
    margin-bottom: 3px;
    font-size: 0.95rem;
}

.material-teacher {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 2px;
}

.material-date {
    color: #999;
    font-size: 0.85rem;
}

.material-actions {
    flex-shrink: 0;
    display: flex;
    gap: 8px;
    align-items: center;
}

.material-actions .btn {
    min-width: 80px;
}

.card {
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border: none;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.card-header h5 {
    margin: 0;
    font-weight: 600;
    color: #495057;
}

.table th {
    background-color: #f8f9fa;
    border-top: none;
    font-weight: 600;
}

/* Responsive Design */
@media (max-width: 768px) {
    .material-item {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .material-icon {
        margin-right: 0;
        margin-bottom: 10px;
    }
    
    .material-actions {
        justify-content: center;
        margin-top: 10px;
    }
}

@media (max-width: 576px) {
    .material-actions {
        flex-direction: column;
        gap: 5px;
        width: 100%;
    }
    
    .material-actions .btn {
        width: 100%;
    }
}
</style>

<script>
// Search and filter functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchNotes');
    const subjectFilter = document.getElementById('filterSubject');
    const typeFilter = document.getElementById('filterType');
    
    if (searchInput) {
        searchInput.addEventListener('input', filterNotes);
    }
    
    if (subjectFilter) {
        subjectFilter.addEventListener('change', filterNotes);
    }
    
    if (typeFilter) {
        typeFilter.addEventListener('change', filterNotes);
    }
});

function filterNotes() {
    const searchTerm = document.getElementById('searchNotes').value.toLowerCase();
    const selectedSubject = document.getElementById('filterSubject').value;
    const selectedType = document.getElementById('filterType').value;
    const materialItems = document.querySelectorAll('.material-item');
    
    materialItems.forEach(function(item) {
        const title = item.querySelector('.material-title').textContent.toLowerCase();
        const subject = item.querySelector('.material-subject').textContent;
        
        // Determine type based on item classes
        let itemType = 'notes'; // default
        if (item.classList.contains('question-bank-item')) {
            itemType = 'question_bank';
        } else if (item.classList.contains('reference-item')) {
            itemType = 'reference';
        } else if (item.classList.contains('slides-item')) {
            itemType = 'slides';
        }
        
        const matchesSearch = title.includes(searchTerm);
        const matchesSubject = selectedSubject === '' || subject === selectedSubject;
        const matchesType = selectedType === '' || itemType === selectedType;
        
        if (matchesSearch && matchesSubject && matchesType) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
}

function clearFilters() {
    document.getElementById('searchNotes').value = '';
    document.getElementById('filterSubject').value = '';
    document.getElementById('filterType').value = '';
    filterNotes();
}

function deleteNote(materialId) {
    if (confirm('Are you sure you want to delete this material?')) {
        fetch(`/materials/delete/${materialId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting material: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting material: ' + error.message);
        });
    }
}


// Track downloads (for analytics)
document.addEventListener('click', function(e) {
    if (e.target.closest('[download]')) {
        const materialTitle = e.target.closest('.material-item').querySelector('.material-title').textContent;
        console.log('Downloaded:', materialTitle);
        // Here you could send analytics data to your backend
    }
});
</script>
{% endblock %}
